<html>
<link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/favicon/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
<link rel="manifest" href="/favicon/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/favicon/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
<head>
<title>
Dawn Console
</title>
</head>
<style>
  body,html
  {
    background-color:black;
    margin:0;
	padding:0;
  }
  @font-face { 
	font-family: 'Inconsolata'; 
	src: url('/font/Inconsolata.eot?#iefix') 
	format('embedded-opentype'), url('/font/Inconsolata.otf') 
	format('opentype'), url('/font/Inconsolata.woff') 
	format('woff'), url('/font/Inconsolata.ttf') 
	format('truetype'), url('/font/Inconsolata.svg#Inconsolata') 
	format('svg'); 
	font-weight: 
	normal; 
	font-style:
	normal; 
  }
  textarea 
  {
    margin:0;
	padding:0;
    background-color: transparent;
	border-style: none; 
    border-color: transparent;   
	resize: none;
    outline: none;
	color: gray;
	font-family: Inconsolata;
	font-size: 12pt;
    position:absolute; 
    width:100%;
    top:0; 
	bottom:0;
	caret-color: gray;
  }
</style>
<script src="require.js"></script>
<body onload="autoFocus()">
<form method="post" action="query.php">
<textarea id="console" autofocus="autofocus" type="text" name="txtarea" onkeydown="processKey(event, this)" onpaste="processPaste(event, this)">
</textarea>
</form>
 <script>
  Hub = require("hubclient");
  var hub = Hub.createClient();

function updateConsole()
{
    if (!console_element)
	   console_element  = document.getElementById('console');
	console_element.value = console_history + console_prefix + console_command;
	console_element.selectionStart = console_history.length + console_prefix.length + console_cursor_position; // consider allowing shift selections and cut copy paste
	console_element.selectionEnd   = console_history.length + console_prefix.length + console_cursor_position;
}


var console_element = null;
var console_history = "";
var console_cursor_position = 0;
var console_prefix = "#> ";
var console_command = "";
var console_command_history = [];
var console_command_history_position = -1;
updateConsole();

function processKey(e) {
    var code = (e.keyCode ? e.keyCode : e.which);
	      e.preventDefault();
    if (code == 8 && console_cursor_position > 0) // backspace
	{
	    console_cursor_position -=1;
 		console_command = console_command.substring(0,console_cursor_position) + console_command.substring(console_cursor_position+1);
    }
	else
    if (code == 37 && console_cursor_position > 0) // left
	{
	    console_cursor_position -=1;
    }
	else
    if (code == 39 && console_cursor_position < console_command.length) // right
	{
	    console_cursor_position +=1;
    }
	else
    if (code == 38 || (code == 9 && !e.shiftKey)) // up or unshifted tab
	{
		if (console_command_history_position == -1 || ++console_command_history_position >= console_command_history.length)
			console_command_history_position = 0;
		if (console_command_history.length > 0)
			console_command = console_command_history[console_command_history_position];
    }
	else
    if (code == 40 || (code == 9 && e.shiftKey)) // down or shifted tab
	{
		if (console_command_history_position == -1 || --console_command_history_position < 0)
			console_command_history_position = console_command_history.length-1;
		if (console_command_history.length > 0)
			console_command = console_command_history[console_command_history_position];
    }
	else
	if (code == 13) // return 
	{ 
		hub.server.eval("dawnCommand(\"" + console_command + "\")");
		console_history += console_prefix + console_command + "\r";
        if (console_command_history.length == 0 || console_command != console_command_history[0])
			console_command_history.unshift(console_command);
        console_command_history_position = -1;		
		console_command = "";
		console_cursor_position = 0;
		console.log(console_command);
	}
	else
	if (e.key.length === 1)
	{
		console_command = console_command.substring(0,console_cursor_position) + e.key + console_command.substring(console_cursor_position);
		console_cursor_position += 1;
	}
	else
	  console.log(code);
    updateConsole();
}

function processPaste(e)
{
   e.stopPropagation();
   e.preventDefault();
   // remember to delete any selection when pasting
   // also consider splitting it by newlines and applying commands one by one
   pastedData = (e.clipboardData || window.clipboardData).getData('text');
   console_command = console_command.substring(0,console_cursor_position) + pastedData + console_command.substring(console_cursor_position);
   console_cursor_position += pastedData.length;
   updateConsole();
}

function print(s)
{
  console_history += s + "\n"; 	
  updateConsole();
  console.log("print called");
}

function autoFocus()
{
    if (!console_element)
	   console_element  = document.getElementById('console');
    console_element.focus();
}
</script>
</body>
</html>